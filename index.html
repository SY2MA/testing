<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>BPER Banca - Mobile Banking</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BPER Banking">
    <link rel="apple-touch-icon" href="https://www.bper.it/o/bper-theme/images/bper/favicon/apple-touch-icon.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* --- THEME & VARIABLES --- */
        :root {
            --bper-green-dark: #005057;
            --bper-green-medium: #13666c;
            --bper-green-light: #e0f2f1;
            --bper-green-background: #f0fafa;
            --white: #fff;
            --light-grey: #f0f0f0;
            --border-color: #e0e0e0;
            --text-dark: #003a40;
            --text-light: #5f787a;
            --shadow: 0 4px 15px rgba(0, 80, 87, 0.1);
            --safe-area-bottom: env(safe-area-inset-bottom);
            --edit-highlight-color: #ffc107; /* Giallo per la modalit√† modifica */
        }

        /* --- GLOBAL & BODY --- */
        html { overflow-x: hidden; width: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bper-green-dark);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        body.modal-open { overflow: hidden; }

        /* --- EDIT MODE --- */
        #edit-mode-banner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9998;
            background-color: var(--edit-highlight-color);
            color: var(--text-dark);
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #edit-mode-banner button {
            background: var(--text-dark);
            color: var(--white);
            border: none;
            border-radius: 5px;
            padding: 4px 8px;
            font-size: 12px;
            margin-left: 10px;
            cursor: pointer;
        }
        .edit-mode-active {
            padding-top: 38px; /* Spazio per il banner */
        }
        .edit-mode-active [data-editable="true"] {
            outline: 2px dashed var(--edit-highlight-color);
            outline-offset: 2px;
            background-color: rgba(255, 193, 7, 0.1);
            cursor: text;
            border-radius: 4px;
        }

        /* --- HEADER --- */
        .app-header {
            background-color: var(--bper-green-dark);
            color: var(--white);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background-color 0.3s ease, backdrop-filter 0.3s ease;
        }
        .edit-mode-active .app-header { top: 38px; } /* Sposta header sotto il banner */

        .app-header.scrolled {
            background-color: rgba(0, 80, 87, 0.8);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; }
        .profile-initials {
            background-color: var(--white);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            font-size: 16px;
            color: var(--bper-green-dark);
            cursor: pointer;
            user-select: none;
        }
        .header-icons { display: flex; gap: 22px; font-size: 22px; color: var(--white); }
        .nav-tabs {
            display: flex;
            padding-bottom: 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            gap: 12px;
        }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .nav-tab {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all .3s ease;
            background-color: var(--bper-green-medium);
            color: var(--white);
            border: 1px solid transparent;
        }
        .nav-tab.active { background-color: var(--white); color: var(--bper-green-dark); }
        
        /* --- MAIN CONTENT --- */
        main {
            flex-grow: 1;
            padding: 20px 0 calc(95px + var(--safe-area-bottom));
            background-color: var(--bper-green-dark);
        }
        .content-section { display: none; padding: 0 20px; }
        .content-section.active-content { display: block; }
        
        /* Account Summary */
        .account-title-outside {
            font-size: 22px;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .account-title-outside .toggle-icon { font-size: 22px; color: var(--white); cursor: pointer; }
        .account-summary {
            background-color: var(--white);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }
        .account-balance {
            font-size: 34px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .account-balance .arrow-icon { font-size: 20px; margin-left: 10px; color: var(--text-light); }
        .balance-info { font-size: 14px; color: var(--text-light); margin-bottom: 20px; }
        .iban-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bper-green-background);
            border-radius: 12px;
            padding: 12px 15px;
            font-size: 14px;
            font-weight: 500;
        }
        .iban-details .copy-icon { color: var(--bper-green-dark); font-size: 18px; cursor: pointer; }
        
        /* Quick Actions (Reverted to original style as requested) */
        .quick-actions {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
            padding: 0;
        }
        .action-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
            position: relative;
        }
        .action-item .icon-wrapper {
            background-color: var(--light-grey);
            border-radius: 16px;
            width: 64px;
            height: 64px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 8px;
            font-size: 28px;
            color: var(--text-dark);
        }
        .action-item span {
            font-size: 13px;
            color: var(--white);
            font-weight: 500;
            line-height: 1.3;
        }
        .action-item:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 60%;
            width: 1px;
            background-color: rgba(255, 255, 255, 0.2);
        }
        .action-item .icon-wrapper.inverted-colors {
            background-color: var(--white);
            color: var(--bper-green-dark);
        }


        /* --- TRANSACTIONS LIST --- */
        .loader { text-align: center; padding: 40px 0; }
        .loader .fa-spinner { font-size: 30px; color: var(--white); }
        .transactions-card-wrapper {
            background-color: var(--white);
            border-radius: 20px;
            padding: 20px 0 0 0;
            box-shadow: var(--shadow);
            color: var(--text-dark);
        }
        .section-title { font-size: 18px; font-weight: 700; padding: 0 20px 15px 20px; margin: 0; }
        .transaction-group-header {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            background-color: var(--bper-green-background);
            padding: 8px 20px;
            margin: 0;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }
        #main-transactions-list .transaction-group-header:first-child { border-top: none; }
        .transaction-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color .2s ease;
            border-bottom: 1px solid var(--border-color);
        }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-item:hover { background-color: var(--bper-green-background); }
        .transaction-item .category-icon {
            font-size: 18px;
            color: var(--white);
            background-color: var(--bper-green-medium);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .transaction-info { flex-grow: 1; min-width: 0; }
        .transaction-name {
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }
        .transaction-type {
            font-size: 13px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .transaction-status {
            font-size: 11px;
            background: var(--light-grey);
            padding: 2px 8px;
            border-radius: 10px;
        }
        .transaction-amount {
            font-size: 16px;
            font-weight: 700;
            white-space: nowrap;
            text-align: right;
        }
        .transaction-amount.positive { color: #2e7d32; } /* Green for income */
        .transaction-amount.negative { color: var(--text-dark); }
        .view-all-container {
            text-align: center;
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
        }
        .view-all-button {
            background: none;
            border: none;
            color: var(--bper-green-dark);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        /* --- PLACEHOLDER FOR OTHER SECTIONS --- */
        .placeholder-section {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: calc(100vh - 400px); text-align: center; color: var(--white);
        }
        .placeholder-section i { font-size: 50px; color: rgba(255, 255, 255, 0.3); margin-bottom: 20px; }
        .placeholder-section h3 { font-size: 22px; margin-bottom: 10px; }
        .placeholder-section p { font-size: 16px; line-height: 1.5; max-width: 80%; opacity: 0.8; }
        
        /* --- ALL TRANSACTIONS SCREEN --- */
        #all-transactions-content {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bper-green-background);
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .edit-mode-active #all-transactions-content { top: 38px; height: calc(100% - 38px); }
        #all-transactions-content.active { transform: translateX(0); }
        .all-transactions-header {
            background-color: var(--white);
            color: var(--text-dark);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            position: sticky; top: 0; z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .all-transactions-header .back-arrow { font-size: 24px; cursor: pointer; padding-right: 15px; }
        .all-transactions-header .title-and-balance { text-align: center; flex-grow: 1; }
        .all-transactions-header .title { font-size: 18px; font-weight: 700; margin: 0; }
        .all-transactions-header .subtitle { font-size: 13px; color: var(--text-light); }
        .search-filter-section {
            background-color: var(--white);
            padding: 15px 20px;
            position: sticky; top: 64px; /* Header height */ z-index: 9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .search-bar-container {
            display: flex; align-items: center; background-color: var(--bper-green-background);
            border-radius: 12px; padding: 0 15px;
        }
        .search-bar-container i.fa-search { color: var(--text-light); }
        .search-bar-container input {
            flex-grow: 1; border: none; outline: none; font-size: 16px;
            background: transparent; color: var(--text-dark); height: 44px; padding: 0 10px;
        }
        .clear-search-btn {
            background: var(--text-light); color: var(--white); border: none; border-radius: 50%;
            width: 20px; height: 20px; font-size: 12px; cursor: pointer;
            display: none; /* Hidden by default */
        }
        .all-transactions-tabs {
            display: flex; background-color: var(--bper-green-background);
            border-radius: 12px; overflow: hidden; margin-top: 15px;
        }
        .all-transactions-tabs .tab {
            flex: 1; padding: 12px 5px; text-align: center; font-size: 15px;
            font-weight: 600; color: var(--text-light); cursor: pointer;
            transition: all 0.3s ease;
        }
        .all-transactions-tabs .tab.active { background-color: var(--bper-green-dark); color: var(--white); }
        .all-transactions-list-container { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .no-results-message {
            text-align: center; padding: 50px 20px; color: var(--text-light); display: none;
        }
        .no-results-message i { font-size: 40px; margin-bottom: 15px; }
        .no-results-message p { font-size: 16px; font-weight: 500; }
        #all-transactions-list .transaction-item {
             background-color: var(--white); border-radius: 16px;
             margin-bottom: 12px; box-shadow: var(--shadow);
             border-bottom: none;
        }
        
        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background-color: rgba(255, 255, 255, 0.9);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            padding: 8px 10px var(--safe-area-bottom);
            display: flex;
            justify-content: space-around;
            border-top: 1px solid rgba(0,0,0,0.1);
            z-index: 150;
        }
        .bottom-nav .nav-item {
            display: flex; flex-direction: column; align-items: center;
            font-size: 11px; color: var(--text-light); text-decoration: none;
            padding: 5px 10px; transition: color .3s ease;
        }
        .bottom-nav .nav-item i { font-size: 22px; margin-bottom: 4px; }
        .bottom-nav .nav-item.active { color: var(--bper-green-dark); }

        /* --- TRANSACTION DETAIL POPUP --- */
        #modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 299; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .edit-mode-active #modal-backdrop { z-index: 999; }
        #modal-backdrop.active { opacity: 1; visibility: visible; }
        #transaction-detail-popup {
            background-color: var(--bper-green-background);
            position: fixed; left: 0; right: 0; bottom: 0;
            max-height: 90vh; border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15); z-index: 300;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .edit-mode-active #transaction-detail-popup { z-index: 1000; }
        #transaction-detail-popup.active { transform: translateY(0); }
        .popup-handle {
            width: 40px; height: 5px; background-color: var(--border-color);
            border-radius: 2.5px; margin: 10px auto;
        }
        .transaction-detail-wrapper {
            flex-grow: 1; padding: 0 20px 30px 20px; overflow-y: auto;
        }
        .detail-header { text-align: center; padding-bottom: 20px; }
        .detail-category-icon {
            width: 60px; height: 60px; font-size: 28px; margin: 0 auto 15px auto;
            color: var(--white); background-color: var(--bper-green-medium);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        .detail-amount { font-size: 36px; font-weight: 700; }
        .detail-name { font-size: 18px; font-weight: 500; margin-top: 5px; }
        .detail-info-block {
            background-color: var(--white); border-radius: 16px;
            padding: 15px; margin-top: 20px;
        }
        .detail-info-row {
            display: flex; justify-content: space-between; font-size: 15px;
            padding: 12px 0; border-bottom: 1px solid var(--border-color);
        }
        .detail-info-row:last-child { border-bottom: none; }
        .detail-info-row span:first-child { color: var(--text-light); }
        .detail-info-row span:last-child { font-weight: 600; color: var(--text-dark); }
        
        /* --- TOAST NOTIFICATION --- */
        .toast-notification {
            position: fixed;
            bottom: calc(95px + var(--safe-area-bottom)); /* Above bottom nav */
            left: 50%;
            transform: translate(-50%, 20px);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .toast-notification.show { opacity: 1; visibility: visible; transform: translate(-50%, 0); }
    </style>
</head>
<body>

    <div id="edit-mode-banner">
        üïµÔ∏è‚Äç‚ôÇÔ∏è Modalit√† Modifica Attiva
        <button id="exit-edit-mode">Esci</button>
    </div>

    <header class="app-header">
        <div class="header-top">
            <div class="profile-initials">MS</div>
            <div class="header-icons">
                <i class="fa-solid fa-bell"></i>
                <i class="fa-solid fa-circle-question"></i>
            </div>
        </div>
        <nav class="nav-tabs">
            <div class="nav-tab active" data-target="conti-content">Conti</div>
            <div class="nav-tab" data-target="carte-content">Carte</div>
            <div class="nav-tab" data-target="finanziamenti-content">Finanziamenti</div>
            <div class="nav-tab" data-target="investimenti-content">Investimenti</div>
            <div class="nav-tab" data-target="mutui-content">Mutui</div>
            <div class="nav-tab" data-target="assicurazioni-content">Assicurazioni</div>
        </nav>
    </header>

    <main id="main-content">
        <div id="conti-content" class="content-section active-content">
            <h3 class="account-title-outside">
                <span data-editable="true" data-field="account-title">Conto 3657761</span>
                <i id="toggle-all-visibility" class="fa-solid fa-eye-slash toggle-icon"></i>
            </h3>
            <div class="account-summary">
                <div class="account-balance">
                    <span id="current-balance" data-editable="true" data-field="balance" data-balance="161.46">161,46&nbsp;‚Ç¨</span>
                    <i class="fa-solid fa-chevron-right arrow-icon"></i>
                </div>
                <p class="balance-info">Saldo disponibile al <span id="balance-date"></span><br><strong data-editable="true" data-field="account-holder">Sy Mouhamadou</strong></p>
                <div class="iban-details">
                    <span id="iban-text" data-editable="true" data-field="iban">IT25 C053 8753 3500 0000 3657761</span>
                    <i id="copy-iban-button" class="fa-solid fa-arrow-up-from-bracket copy-icon"></i>
                </div>
            </div>
            
            <div class="quick-actions">
                <div class="action-item">
                    <div class="icon-wrapper inverted-colors"><i class="fas fa-hand-holding-dollar"></i></div>
                    <span>Bonifico<br>ordinario</span>
                </div>
                <div class="action-item">
                    <div class="icon-wrapper inverted-colors"><i class="fas fa-mobile-screen-button"></i></div>
                    <span>Ricarica<br>Telefonica</span>
                </div>
                <div class="action-item">
                    <div class="icon-wrapper inverted-colors"><i class="fas fa-file-invoice"></i></div>
                    <span>Cbill e<br>PagoPA</span>
                </div>
            </div>
            
            <div class="loader">
                <i class="fas fa-spinner fa-spin"></i>
            </div>

            <div class="transactions-card-wrapper" style="display: none;">
                <h2 class="section-title">ULTIMI MOVIMENTI</h2>
                <div class="transactions" id="main-transactions-list"></div>
                <div class="view-all-container">
                    <button id="view-all-transactions-btn" class="view-all-button">Visualizza tutto</button>
                </div>
            </div>
        </div>

        <section id="carte-content" class="content-section"><div class="placeholder-section"><i class="fa-solid fa-credit-card"></i><h3>Le tue Carte</h3><p>Gestisci limiti, pagamenti e sicurezza delle tue carte.</p></div></section>
        <section id="finanziamenti-content" class="content-section"><div class="placeholder-section"><i class="fa-solid fa-chart-line"></i><h3>Finanziamenti</h3><p>Controlla lo stato dei tuoi prestiti e finanziamenti.</p></div></section>
        <section id="investimenti-content" class="content-section"><div class="placeholder-section"><i class="fa-solid fa-seedling"></i><h3>Investimenti</h3><p>Monitora l'andamento del tuo portafoglio.</p></div></section>
        <section id="mutui-content" class="content-section"><div class="placeholder-section"><i class="fa-solid fa-house-chimney"></i><h3>Mutui</h3><p>Visualizza i dettagli e le rate del tuo mutuo.</p></div></section>
        <section id="assicurazioni-content" class="content-section"><div class="placeholder-section"><i class="fa-solid fa-shield-halved"></i><h3>Assicurazioni</h3><p>Gestisci le tue polizze e i tuoi sinistri.</p></div></section>
    </main>

    <section id="all-transactions-content">
        <div class="all-transactions-header">
            <i class="fa-solid fa-arrow-left back-arrow" id="back-to-conti"></i>
            <div class="title-and-balance">
                <h2 class="title">Movimenti Conto</h2>
                <span class="subtitle">Conto 3657761</span>
            </div>
        </div>
        <div class="search-filter-section">
            <div class="search-bar-container">
                <i class="fa-solid fa-search"></i>
                <input type="text" id="transaction-search-input" placeholder="Cerca per nome o importo">
                <button class="clear-search-btn">&times;</button>
            </div>
            <div class="all-transactions-tabs">
                <div class="tab active" data-filter="all">Tutti</div>
                <div class="tab" data-filter="incomes">Entrate</div>
                <div class="tab" data-filter="expenses">Uscite</div>
            </div>
        </div>
        <div class="all-transactions-list-container">
            <div id="all-transactions-list" class="transactions"></div>
            <div class="no-results-message">
                <i class="fa-solid fa-box-open"></i>
                <p>Nessun movimento trovato</p>
            </div>
        </div>
    </section>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active"><i class="fa-solid fa-house"></i><span>Home</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-arrows-rotate"></i><span>Paga</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-qrcode"></i><span>QR</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-wallet"></i><span>Prodotti</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-bars"></i><span>Menu</span></a>
    </nav>

    <div id="modal-backdrop"></div>
    <div id="transaction-detail-popup">
        <div class="popup-handle"></div>
        <div class="transaction-detail-wrapper"></div>
    </div>
    <div id="toast-notification" class="toast-notification">Testo del toast</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- DATA ---
    const categoryIcons = {
        'payment': 'fa-solid fa-credit-card',
        'transfer_in': 'fa-solid fa-arrow-down',
        'transfer_out': 'fa-solid fa-arrow-up',
        'salary': 'fa-solid fa-briefcase',
        'groceries': 'fa-solid fa-cart-shopping',
        'fuel': 'fa-solid fa-gas-pump',
        'cash': 'fa-solid fa-money-bill-wave',
        'bills': 'fa-solid fa-file-invoice-dollar',
        'health': 'fa-solid fa-prescription-bottle-medical',
        'loan': 'fa-solid fa-money-check-dollar',
        'phone': 'fa-solid fa-mobile-screen-button',
        'car_wash': 'fa-solid fa-car-wash',
        'restaurant': 'fa-solid fa-utensils',
        'default': 'fa-solid fa-receipt'
    };

let transactionsData = [
{ id: 'tx_agosto_1', accountingDate: new Date('2025-08-04'), currencyDate: new Date('2025-08-04'), name: 'Premi assicurativi', type: 'ADDEBITO', amount: -12.00, status: null, details: 'Addebito premi assicurativi', category: 'bills'},
        // Agosto
        { id: 'tx_agosto_1', accountingDate: new Date('2025-08-04'), currencyDate: new Date('2025-08-04'), name: 'Premi assicurativi', type: 'ADDEBITO', amount: -12.00, status: null, details: 'Addebito premi assicurativi', category: 'bills'},
        { id: 'tx_agosto_2', accountingDate: new Date('2025-08-04'), currencyDate: new Date('2025-08-04'), name: 'Richiesta lista mov. da ATM', type: 'SPESE BANCARIE', amount: -0.66, status: null, details: 'Costo per richiesta lista movimenti da ATM', category: 'payment'},

        // Luglio
        { id: 'tx_luglio_1', accountingDate: new Date('2025-07-25'), currencyDate: new Date('2025-07-25'), name: 'Rata prestito BSS Bibanc...', type: 'ADDEBITO RATA PRESTITO', amount: -145.60, status: null, details: 'Rata mensile prestito', category: 'loan'},
        { id: 'tx_luglio_2', accountingDate: new Date('2025-07-18'), currencyDate: new Date('2025-07-18'), name: 'Prelievo da CSA', type: 'PRELIEVO CONTANTI', amount: -150.00, status: null, details: 'Prelievo contanti', category: 'cash'},
        { id: 'tx_luglio_3', accountingDate: new Date('2025-07-14'), currencyDate: new Date('2025-07-14'), name: 'Prelievo ATM c/o Clusone O...', type: 'PRELIEVO CONTANTI', amount: -700.00, status: null, details: 'Prelievo contanti da ATM', category: 'cash'},
        { id: 'tx_luglio_4', accountingDate: new Date('2025-07-11'), currencyDate: new Date('2025-07-11'), name: 'Comm. bon. istantaneo a fav...', type: 'SPESE BANCARIE', amount: -1.49, status: null, details: 'Commissione per bonifico istantaneo', category: 'payment'},
        { id: 'tx_luglio_5', accountingDate: new Date('2025-07-11'), currencyDate: new Date('2025-07-11'), name: 'Disposizione bonifico IS...', type: 'BONIFICO IN USCITA', amount: -440.00, status: null, details: 'Bonifico istantaneo', category: 'transfer_out'},
        { id: 'tx_luglio_6', accountingDate: new Date('2025-07-11'), currencyDate: new Date('2025-07-11'), name: 'Prelievo ATM c/o Clusone...', type: 'PRELIEVO CONTANTI', amount: -1040.00, status: null, details: 'Prelievo contanti da ATM', category: 'cash'},
        { id: 'tx_luglio_7', accountingDate: new Date('2025-07-10'), currencyDate: new Date('2025-07-10'), name: 'Emolumenti o/c: Terya...', type: 'ACCREDITO STIPENDIO', amount: 2483.00, status: null, details: 'Accredito emolumenti', category: 'salary'},
        { id: 'tx_luglio_8', accountingDate: new Date('2025-07-04'), currencyDate: new Date('2025-07-04'), name: 'Lidl 148 Clusone Ita Operazi...', type: 'PAGAMENTO CARTA', amount: -3.58, status: 'Contabilizzato', details: 'Pagamento spesa alimentare', category: 'groceries'},
        { id: 'tx_luglio_9', accountingDate: new Date('2025-07-03'), currencyDate: new Date('2025-07-03'), name: 'Competenze spese ed oneri', type: 'SPESE BANCARIE', amount: -5.00, status: null, details: 'Spese di gestione conto', category: 'payment'},

        // Giugno
        { id: 'tx_giugno_1', accountingDate: new Date('2025-06-30'), currencyDate: new Date('2025-06-30'), name: 'AMP07 Clusone BG Operazio...', type: 'PAGAMENTO CARTA', amount: -11.60, status: 'Contabilizzato', details: 'Pagamento generico', category: 'payment'},
        { id: 'tx_giugno_2', accountingDate: new Date('2025-06-25'), currencyDate: new Date('2025-06-25'), name: 'Rata prestito BSS Bibanc...', type: 'ADDEBITO RATA PRESTITO', amount: -145.60, status: null, details: 'Rata mensile prestito', category: 'loan'},
        { id: 'tx_giugno_3', accountingDate: new Date('2025-06-24'), currencyDate: new Date('2025-06-24'), name: 'Lidl 148 Clusone Ita Operazi...', type: 'PAGAMENTO CARTA', amount: -5.28, status: 'Contabilizzato', details: 'Pagamento spesa alimentare', category: 'groceries'},
        { id: 'tx_giugno_4', accountingDate: new Date('2025-06-24'), currencyDate: new Date('2025-06-24'), name: 'Energy Self Albino Albino I...', type: 'PAGAMENTO CARTA', amount: -4.77, status: 'Contabilizzato', details: 'Rifornimento carburante', category: 'fuel'},
        { id: 'tx_giugno_5', accountingDate: new Date('2025-06-24'), currencyDate: new Date('2025-06-24'), name: 'Lidl 2079 Bergamo Ita Opera...', type: 'PAGAMENTO CARTA', amount: -3.28, status: 'Contabilizzato', details: 'Pagamento spesa alimentare', category: 'groceries'},
        { id: 'tx_giugno_6', accountingDate: new Date('2025-06-23'), currencyDate: new Date('2025-06-23'), name: 'Versamento da ATM azien...', type: 'VERSAMENTO', amount: 20.00, status: null, details: 'Versamento contanti da ATM', category: 'cash'},
        { id: 'tx_giugno_7', accountingDate: new Date('2025-06-19'), currencyDate: new Date('2025-06-19'), name: 'Aldi S.R.L. Pedrengo Ita Ope...', type: 'PAGAMENTO CARTA', amount: -4.24, status: 'Contabilizzato', details: 'Pagamento spesa alimentare', category: 'groceries'},
        { id: 'tx_giugno_8', accountingDate: new Date('2025-06-17'), currencyDate: new Date('2025-06-17'), name: 'HO-MOBILE.IT - Ricaric Mila...', type: 'RICARICA TELEFONICA', amount: -10.00, status: 'Contabilizzato', details: 'Ricarica telefonica', category: 'phone'},
        { id: 'tx_giugno_9', accountingDate: new Date('2025-06-16'), currencyDate: new Date('2025-06-16'), name: 'Autolavaggio cassa 2 Clus...', type: 'PAGAMENTO CARTA', amount: -5.00, status: 'Contabilizzato', details: 'Pagamento autolavaggio', category: 'car_wash'},
        { id: 'tx_giugno_10', accountingDate: new Date('2025-06-16'), currencyDate: new Date('2025-06-16'), name: 'Versamento da ATM azien...', type: 'VERSAMENTO', amount: 150.00, status: null, details: 'Versamento contanti da ATM', category: 'cash'},
        { id: 'tx_giugno_11', accountingDate: new Date('2025-06-16'), currencyDate: new Date('2025-06-16'), name: 'Bella Pizza Kebap Bergamo...', type: 'PAGAMENTO CARTA', amount: -5.00, status: 'Contabilizzato', details: 'Pagamento ristorante/take-away', category: 'restaurant'},
        { id: 'tx_giugno_12', accountingDate: new Date('2025-06-12'), currencyDate: new Date('2025-06-12'), name: '0208-Italmark Bergamo Be...', type: 'PAGAMENTO CARTA', amount: -1.86, status: 'Contabilizzato', details: 'Pagamento spesa alimentare', category: 'groceries'},
        
        // Esempi precedenti mantenuti
        { id: 'tx556677889', accountingDate: new Date('2025-05-20'), currencyDate: new Date('2025-05-20'), name: 'VERSAMENTO DA ATM', type: 'VERSAMENTO', amount: 20.00, status: null, details: 'Versamento contanti presso ATM', category: 'cash'},
        { id: 'tx123456789', accountingDate: new Date('2025-05-19'), currencyDate: new Date('2025-05-19'), name: 'LIDL SUPERMERCATO', type: 'PAGAMENTO CARTA', amount: -5.28, status: 'Contabilizzato', details: 'Pagamento POS per spesa alimentare', category: 'groceries' },
        { id: 'tx987654321', accountingDate: new Date('2025-05-18'), currencyDate: new Date('2025-05-18'), name: 'ACCREDITO STIPENDIO', type: 'BONIFICO IN ENTRATA', amount: 1850.00, status: null, details: 'Stipendio mensile - Tech Solutions S.R.L.', category: 'salary' },
        { id: 'tx112233445', accountingDate: new Date('2025-05-15'), currencyDate: new Date('2025-05-15'), name: 'ENERGY SELF CARBURANTI', type: 'PAGAMENTO CARTA', amount: -55.00, status: 'Contabilizzato', details: 'Rifornimento carburante', category: 'fuel' },
        { id: 'tx123456789b', accountingDate: new Date('2025-05-14'), currencyDate: new Date('2025-05-14'), name: 'CANONE NETFLIX', type: 'ADDEBITO DIRETTO', amount: -17.99, status: 'Contabilizzato', details: 'Abbonamento mensile', category: 'bills' },
        { id: 'tx987654321c', accountingDate: new Date('2025-05-13'), currencyDate: new Date('2025-05-13'), name: 'GIROCONTO DA ANNA ROSSI', type: 'GIROCONTO', amount: 150.00, status: null, details: 'Quota cena', category: 'transfer_in' }
    ];

    // --- STATE VARIABLES ---
    let balancesVisible = true;
    let currentFilter = 'all';
    let editMode = false;
    let profileClickCount = 0;
    let profileClickTimer = null;

    // --- DOM ELEMENTS ---
    const body = document.body;
    const mainContent = document.getElementById('main-content');
    const header = document.querySelector('.app-header');
    const mainTransactionsList = document.getElementById('main-transactions-list');
    const allTransactionsList = document.getElementById('all-transactions-list');
    const searchInput = document.getElementById('transaction-search-input');
    const clearSearchBtn = document.querySelector('.clear-search-btn');
    const profileInitials = document.querySelector('.profile-initials');
    const editModeBanner = document.getElementById('edit-mode-banner');

    // --- INITIALIZATION ---
    function init() {
        // Simulate data loading
        setTimeout(() => {
            document.querySelector('.loader').style.display = 'none';
            document.querySelector('.transactions-card-wrapper').style.display = 'block';
            rerenderAllLists();
        }, 800);

        setupEventListeners();
        updateBalanceDate();
    }
    
    // --- EVENT LISTENERS SETUP ---
    function setupEventListeners() {
        mainContent.addEventListener('scroll', () => { header.classList.toggle('scrolled', mainContent.scrollTop > 10); });
        
        document.querySelector('.nav-tabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('nav-tab')) {
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(content => content.classList.remove('active-content'));
                e.target.classList.add('active');
                document.getElementById(e.target.dataset.target).classList.add('active-content');
            }
        });
        
        document.getElementById('toggle-all-visibility').addEventListener('click', toggleBalanceVisibility);
        document.getElementById('copy-iban-button').addEventListener('click', copyIban);
        document.getElementById('view-all-transactions-btn').addEventListener('click', showAllTransactionsScreen);
        document.getElementById('back-to-conti').addEventListener('click', hideAllTransactionsScreen);

        // Search and filter
        searchInput.addEventListener('input', handleSearchAndFilter);
        clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; handleSearchAndFilter(); });
        document.querySelector('.all-transactions-tabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('tab')) {
                document.querySelectorAll('.all-transactions-tabs .tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                handleSearchAndFilter();
            }
        });

        // Transaction detail popup
        body.addEventListener('click', (e) => {
            if (editMode) return; // Disable popup in edit mode
            const transactionItem = e.target.closest('.transaction-item');
            if (transactionItem) {
                const transaction = transactionsData.find(t => t.id === transactionItem.dataset.id);
                if (transaction) showTransactionDetail(transaction);
            }
        });
        document.getElementById('modal-backdrop').addEventListener('click', hideTransactionDetail);

        // Edit Mode Listeners
        profileInitials.addEventListener('click', handleProfileClick);
        document.getElementById('exit-edit-mode').addEventListener('click', () => toggleEditMode(false));
    }
    
    // --- RENDER & DATA UPDATE FUNCTIONS ---

    function rerenderAllLists() {
        renderTransactions(transactionsData.slice(0, 4), mainTransactionsList);
        handleSearchAndFilter(); // This will render the full list
    }
    
    function groupTransactionsByDate(transactions) {
        const groups = {};
        const today = new Date(); today.setHours(0, 0, 0, 0);
        const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
        const thisWeekStart = new Date(today); thisWeekStart.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));

        transactions.forEach(tx => {
            const txDate = new Date(tx.accountingDate); txDate.setHours(0, 0, 0, 0);
            let groupKey;
            if (txDate.getTime() === today.getTime()) groupKey = 'Oggi';
            else if (txDate.getTime() === yesterday.getTime()) groupKey = 'Ieri';
            else if (txDate >= thisWeekStart) groupKey = 'Questa Settimana';
            else groupKey = txDate.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase());
            if (!groups[groupKey]) groups[groupKey] = [];
            groups[groupKey].push(tx);
        });
        return groups;
    }

    function renderTransactions(transactions, container) {
        container.innerHTML = '';
        const groupedTransactions = groupTransactionsByDate(transactions);

        if (transactions.length === 0 && container.id === 'all-transactions-list') {
             document.querySelector('.no-results-message').style.display = 'block';
        } else {
             document.querySelector('.no-results-message').style.display = 'none';
        }

        Object.keys(groupedTransactions).forEach(groupName => {
            if (container.id === 'main-transactions-list') {
                const groupHeader = document.createElement('h3');
                groupHeader.className = 'transaction-group-header';
                groupHeader.textContent = groupName;
                container.appendChild(groupHeader);
            }
            
            groupedTransactions[groupName].forEach(tx => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                item.dataset.id = tx.id;
                
                const amountClass = tx.amount > 0 ? 'positive' : 'negative';
                const formattedAmount = `${tx.amount.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' })}`;

                item.innerHTML = `
                    <div class="category-icon">
                        <i class="${categoryIcons[tx.category] || categoryIcons['default']}"></i>
                    </div>
                    <div class="transaction-info">
                        <div class="transaction-name" data-editable="true" data-field="name">${tx.name}</div>
                        <div class="transaction-type">
                            <span data-editable="true" data-field="type">${tx.type}</span>
                            ${tx.status ? `<span class="transaction-status" data-editable="true" data-field="status">${tx.status}</span>` : ''}
                        </div>
                    </div>
                    <div class="transaction-amount ${amountClass}" data-editable="true" data-field="amount">
                        ${balancesVisible ? formattedAmount : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
                    </div>
                `;
                container.appendChild(item);
            });
        });
        if (editMode) setEditableState(true); // Re-apply editable state after render
    }

    // --- FEATURE FUNCTIONS ---
    
    function handleProfileClick() {
        profileClickCount++;
        if (profileClickCount === 1) {
            profileClickTimer = setTimeout(() => {
                profileClickCount = 0;
            }, 400); // Reset after 400ms
        }
        if (profileClickCount === 3) {
            clearTimeout(profileClickTimer);
            profileClickCount = 0;
            toggleEditMode(); // Toggle current state
        }
    }

    function toggleEditMode(forceState) {
        editMode = (forceState !== undefined) ? forceState : !editMode;
        body.classList.toggle('edit-mode-active', editMode);
        editModeBanner.style.display = editMode ? 'block' : 'none';
        setEditableState(editMode);
    }
    
    function setEditableState(isEditable) {
        document.querySelectorAll('[data-editable="true"]').forEach(el => {
            el.contentEditable = isEditable;
            if (isEditable) {
                el.addEventListener('blur', saveOnBlur);
            } else {
                el.removeEventListener('blur', saveOnBlur);
            }
        });
    }

    function saveOnBlur(e) {
        const element = e.target;
        const field = element.dataset.field;
        const transactionItem = element.closest('.transaction-item');
        let newValue = element.innerText;

        if (transactionItem) { // It's a transaction field
            const txId = transactionItem.dataset.id;
            const transaction = transactionsData.find(t => t.id === txId);
            if (!transaction) return;

            if (field === 'amount') {
                newValue = parseFloat(newValue.replace(/[^0-9,-]+/g, "").replace(',', '.')) || 0;
            }
            transaction[field] = newValue;
            
        } else { // It's a general field (balance, name, etc.)
            const balanceEl = document.getElementById('current-balance');
            if (field === 'balance') {
                const numericValue = parseFloat(newValue.replace(/[^0-9,-]+/g, "").replace(',', '.')) || 0;
                balanceEl.dataset.balance = numericValue;
            }
        }
        // No full re-render on blur to avoid losing focus, changes are saved in the data object.
    }

    function handleSearchAndFilter() {
        const searchTerm = searchInput.value.toLowerCase();
        clearSearchBtn.style.display = searchTerm ? 'block' : 'none';
        const filtered = transactionsData.filter(tx => 
            (tx.name.toLowerCase().includes(searchTerm) || tx.amount.toString().includes(searchTerm)) &&
            (currentFilter === 'all' || (currentFilter === 'incomes' && tx.amount > 0) || (currentFilter === 'expenses' && tx.amount < 0))
        );
        renderTransactions(filtered, allTransactionsList);
    }
    
    function toggleBalanceVisibility() {
        balancesVisible = !balancesVisible;
        const icon = document.getElementById('toggle-all-visibility');
        const balanceEl = document.getElementById('current-balance');
        icon.className = `toggle-icon fa-solid ${balancesVisible ? 'fa-eye-slash' : 'fa-eye'}`;
        
        if (balancesVisible) {
            const val = parseFloat(balanceEl.dataset.balance);
            balanceEl.innerHTML = val.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
        } else {
            balanceEl.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        }
        rerenderAllLists();
    }

    function copyIban() {
        const ibanText = document.getElementById('iban-text').textContent.replace(/\s/g, '');
        navigator.clipboard.writeText(ibanText).then(() => showToast('IBAN copiato!'));
    }

    function showToast(message) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function showTransactionDetail(tx) {
        const popup = document.getElementById('transaction-detail-popup');
        const backdrop = document.getElementById('modal-backdrop');
        const wrapper = popup.querySelector('.transaction-detail-wrapper');
        
        const formattedAmount = tx.amount.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
        wrapper.innerHTML = `
            <div class="detail-header">
                <div class="detail-category-icon"><i class="${categoryIcons[tx.category] || categoryIcons['default']}"></i></div>
                <div class="detail-amount ${tx.amount > 0 ? 'positive' : 'negative'}">${formattedAmount}</div>
                <div class="detail-name">${tx.name}</div>
            </div>
            <div class="detail-info-block">
                <div class="detail-info-row"><span>Causale</span><span>${tx.details}</span></div>
                <div class="detail-info-row"><span>Data contabile</span><span>${new Date(tx.accountingDate).toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' })}</span></div>
                <div class="detail-info-row"><span>Data valuta</span><span>${new Date(tx.currencyDate).toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' })}</span></div>
                <div class="detail-info-row"><span>Tipo movimento</span><span>${tx.type}</span></div>
            </div>
        `;

        body.classList.add('modal-open');
        backdrop.classList.add('active');
        popup.classList.add('active');
    }

    function hideTransactionDetail() {
        const popup = document.getElementById('transaction-detail-popup');
        const backdrop = document.getElementById('modal-backdrop');
        body.classList.remove('modal-open');
        backdrop.classList.remove('active');
        popup.classList.remove('active');
    }

    function showAllTransactionsScreen() { document.getElementById('all-transactions-content').classList.add('active'); }
    function hideAllTransactionsScreen() { document.getElementById('all-transactions-content').classList.remove('active'); }
    function updateBalanceDate() { document.getElementById('balance-date').textContent = new Date().toLocaleDateString('it-IT', { day: '2-digit', month: 'numeric', year: 'numeric' }); }

    // --- START THE APP ---
    init();
});
</script>

</body>
</html>
