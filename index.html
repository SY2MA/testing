<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>BPER Banca - Mobile Banking</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BPER Banking">
    <link rel="apple-touch-icon" href="https://www.bper.it/o/bper-theme/images/bper/favicon/apple-touch-icon.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* --- THEME & VARIABLES --- */
        :root {
            --bper-green-dark: #005057;
            --bper-green-medium: #13666c;
            --bper-green-light: #e0f2f1;
            --bper-green-background: #f0fafa;
            --white: #fff;
            --light-grey: #f0f0f0;
            --border-color: #e0e0e0;
            --text-dark: #003a40;
            --text-light: #5f787a;
            --shadow: 0 4px 15px rgba(0, 80, 87, 0.1);
            --safe-area-bottom: env(safe-area-inset-bottom);
            --edit-highlight-color: #ffc107;
        }

        /* --- GLOBAL & BODY --- */
        html { overflow-x: hidden; width: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bper-green-dark);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        body.modal-open { overflow: hidden; }

        /* --- EDIT MODE --- */
        #edit-mode-banner {
            display: none;
            position: fixed; top: 0; left: 0; right: 0;
            z-index: 9998;
            background-color: var(--edit-highlight-color);
            color: var(--text-dark);
            text-align: center; padding: 8px; font-size: 14px; font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #edit-mode-banner button {
            background: var(--text-dark); color: var(--white);
            border: none; border-radius: 5px;
            padding: 4px 8px; font-size: 12px;
            margin-left: 10px; cursor: pointer;
        }
        .edit-mode-active { padding-top: 38px; }
        .edit-mode-active [data-editable="true"] {
            outline: 2px dashed var(--edit-highlight-color);
            outline-offset: 2px;
            background-color: rgba(255, 193, 7, 0.1);
            cursor: text; border-radius: 4px;
        }

        /* --- HEADER --- */
        .app-header {
            background-color: var(--bper-green-dark);
            color: var(--white); padding: 0 20px;
            position: sticky; top: 0; z-index: 100;
            transition: background-color 0.3s ease, backdrop-filter 0.3s ease;
        }
        .edit-mode-active .app-header { top: 38px; }

        .app-header.scrolled {
            background-color: rgba(0, 80, 87, 0.8);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; }
        .profile-initials {
            background-color: var(--white);
            border-radius: 50%; width: 36px; height: 36px;
            display: flex; justify-content: center; align-items: center;
            font-weight: 600; font-size: 16px; color: var(--bper-green-dark);
            cursor: pointer; user-select: none;
        }
        .header-icons { display: flex; gap: 22px; font-size: 22px; color: var(--white); }
        .nav-tabs {
            display: flex; padding-bottom: 15px;
            overflow-x: auto; -webkit-overflow-scrolling: touch;
            scrollbar-width: none; gap: 12px;
        }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .nav-tab {
            padding: 8px 16px; border-radius: 20px;
            font-size: 15px; font-weight: 500;
            cursor: pointer; white-space: nowrap;
            transition: all .3s ease;
            background-color: var(--bper-green-medium); color: var(--white);
            border: 1px solid transparent;
        }
        .nav-tab.active { background-color: var(--white); color: var(--bper-green-dark); }
        
        /* --- MAIN CONTENT --- */
        main {
            flex-grow: 1;
            padding: 20px 0 calc(95px + var(--safe-area-bottom));
            background-color: var(--bper-green-dark);
        }
        .content-section { display: none; padding: 0 20px; }
        .content-section.active-content { display: block; }
        
        /* Account Summary */
        .account-title-outside {
            font-size: 22px; font-weight: 700; color: var(--white);
            margin-bottom: 15px; display: flex;
            justify-content: space-between; align-items: center;
        }
        .account-title-outside .toggle-icon { font-size: 22px; color: var(--white); cursor: pointer; }
        .account-summary {
            background-color: var(--white); border-radius: 20px;
            padding: 20px; margin-bottom: 25px;
            box-shadow: var(--shadow);
        }
        .account-balance {
            font-size: 34px; font-weight: 700; color: var(--text-dark);
            margin-bottom: 5px; display: flex;
            align-items: center; cursor: pointer;
        }
        .account-balance .arrow-icon { font-size: 20px; margin-left: 10px; color: var(--text-light); }
        .balance-info { font-size: 14px; color: var(--text-light); margin-bottom: 20px; }
        .iban-details {
            display: flex; justify-content: space-between; align-items: center;
            background-color: transparent; 
            border-radius: 12px; padding: 12px 0; 
            font-size: 14px; font-weight: 500; letter-spacing: 0.5px;
        }
        .iban-details .copy-icon { color: var(--bper-green-dark); font-size: 18px; cursor: pointer; }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            justify-content: space-around;
            align-items: flex-start; 
            margin-bottom: 25px;
            padding: 10px 0;
            text-align: center;
        }
        .action-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }
        .action-item i {
            font-size: 24px;
            color: var(--white);
            margin-bottom: 12px;
            height: 25px; 
            line-height: 25px;
        }
        .action-item span {
            font-size: 14px;
            color: var(--white);
            font-weight: 500;
            line-height: 1.3;
        }
        .action-item:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 40px; 
            width: 1px;
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* --- TRANSACTIONS LIST --- */
        .loader { text-align: center; padding: 40px 0; }
        .loader .fa-spinner { font-size: 30px; color: var(--white); }
        .transactions-card-wrapper {
            background-color: var(--white);
            border-radius: 20px; padding: 20px;
            box-shadow: var(--shadow); color: var(--text-dark);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .section-title { 
            font-size: 18px; font-weight: 700; 
            padding: 0; margin: 0; 
        }
        .add-tx-button {
            display: none; /* Nascondi di default */
            background-color: var(--bper-green-medium);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color .2s;
        }
        .add-tx-button:hover {
             background-color: var(--bper-green-dark);
        }
        .edit-mode-active .add-tx-button {
            display: inline-block; /* Mostra solo in modalit√† modifica */
        }
        
        .transaction-item {
            display: flex; align-items: center;
            padding: 12px 0; cursor: pointer;
            transition: background-color .2s ease;
            border-bottom: 1px solid var(--border-color);
        }
        .transactions-card-wrapper .transactions .transaction-item:last-child { 
            border-bottom: none;
        }
        .transaction-date-block {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            width: 50px; flex-shrink: 0;
            margin-right: 15px; color: var(--text-light);
        }
        .transaction-date-block .date-day {
            font-size: 1.2rem; font-weight: 600; color: var(--text-dark);
        }
        .transaction-date-block .date-month {
            font-size: 0.8rem; text-transform: uppercase;
        }
        .transaction-info { flex-grow: 1; min-width: 0; }
        .transaction-name {
            font-weight: 600; font-size: 15px;
            white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis; margin-bottom: 4px;
        }
        .transaction-type {
            font-size: 13px; color: var(--text-light);
            text-transform: uppercase;
        }
        .transaction-amount {
            font-size: 16px; font-weight: 700;
            white-space: nowrap; text-align: right;
            margin-left: 10px;
        }
        .transaction-amount.positive { color: #2e7d32; }
        .transaction-amount.negative { color: var(--text-dark); }
        .view-all-container {
            text-align: center; padding: 15px 0 0 0;
            border-top: 1px solid var(--border-color);
            margin-top: 15px;
        }
        .view-all-button {
            background: none; border: none;
            color: var(--bper-green-dark); font-size: 15px;
            font-weight: 600; cursor: pointer;
        }

        /* --- PLACEHOLDER FOR OTHER SECTIONS --- */
        .placeholder-section {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: calc(100vh - 400px); text-align: center; color: var(--white);
        }
        .placeholder-section i { font-size: 50px; color: rgba(255, 255, 255, 0.3); margin-bottom: 20px; }
        .placeholder-section h3 { font-size: 22px; margin-bottom: 10px; }
        .placeholder-section p { font-size: 16px; line-height: 1.5; max-width: 80%; opacity: 0.8; }
        
        /* --- ALL TRANSACTIONS SCREEN --- */
        #all-transactions-content {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bper-green-background); z-index: 200;
            transform: translateX(100%); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .edit-mode-active #all-transactions-content { top: 38px; height: calc(100% - 38px); }
        #all-transactions-content.active { transform: translateX(0); }
        .all-transactions-header {
            background-color: var(--white); color: var(--text-dark);
            padding: 15px 20px; display: flex; align-items: center;
            position: sticky; top: 0; z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .all-transactions-header .back-arrow { font-size: 24px; cursor: pointer; padding-right: 15px; }
        .all-transactions-header .title-and-balance { text-align: center; flex-grow: 1; }
        .all-transactions-header .title { font-size: 18px; font-weight: 700; margin: 0; }
        .all-transactions-header .subtitle { font-size: 13px; color: var(--text-light); }
        .search-filter-section {
            background-color: var(--white); padding: 10px 20px 15px;
            position: sticky; top: 64px; z-index: 9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .search-and-sort-container {
            display: flex; align-items: center;
            gap: 10px; margin-bottom: 15px;
        }
        .search-bar-container {
            flex-grow: 1; display: flex; align-items: center; 
            background-color: var(--bper-green-background);
            border-radius: 12px; padding: 0 15px;
        }
        .search-bar-container i.fa-search { color: var(--text-light); }
        .search-bar-container input {
            flex-grow: 1; border: none; outline: none; font-size: 16px;
            background: transparent; color: var(--text-dark); 
            height: 44px; padding: 0 10px;
        }
        .clear-search-btn {
            background: var(--text-light); color: var(--white); border: none; 
            border-radius: 50%; width: 20px; height: 20px; 
            font-size: 12px; cursor: pointer; display: none;
        }
        #sort-transactions-btn {
            flex-shrink: 0; width: 44px; height: 44px;
            border-radius: 12px; border: none;
            background-color: var(--bper-green-background);
            color: var(--text-dark); font-size: 18px; cursor: pointer;
        }
        .all-transactions-tabs {
            display: flex; background-color: var(--bper-green-background);
            border-radius: 12px; overflow: hidden;
        }
        .all-transactions-tabs .tab {
            flex: 1; padding: 12px 5px; text-align: center; font-size: 15px;
            font-weight: 600; color: var(--text-light); cursor: pointer;
            transition: all 0.3s ease;
        }
        .all-transactions-tabs .tab.active { background-color: var(--bper-green-dark); color: var(--white); }
        .all-transactions-list-container { flex-grow: 1; overflow-y: auto; padding: 0 20px; }
        .no-results-message {
            text-align: center; padding: 50px 20px; 
            color: var(--text-light); display: none;
        }
        .no-results-message i { font-size: 40px; margin-bottom: 15px; }
        .no-results-message p { font-size: 16px; font-weight: 500; }
        #all-transactions-list .transaction-item {
             background-color: var(--white); border-radius: 16px;
             margin-bottom: 12px; box-shadow: var(--shadow);
             border-bottom: none; padding: 15px;
        }
        
        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: rgba(255, 255, 255, 0.9);
            -webkit-backdrop-filter: blur(15px); backdrop-filter: blur(15px);
            padding: 8px 10px var(--safe-area-bottom);
            display: flex; justify-content: space-around;
            border-top: 1px solid rgba(0,0,0,0.1); z-index: 150;
        }
        .bottom-nav .nav-item {
            display: flex; flex-direction: column; align-items: center;
            font-size: 11px; color: var(--text-light); text-decoration: none;
            padding: 5px 10px; transition: color .3s ease;
        }
        .bottom-nav .nav-item i { font-size: 22px; margin-bottom: 4px; }
        .bottom-nav .nav-item.active { color: var(--bper-green-dark); }

        /* --- POPUP GENERIC STYLES --- */
        #modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 299; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
        }
        .edit-mode-active #modal-backdrop { z-index: 999; }
        #modal-backdrop.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .popup-sheet {
            background-color: var(--bper-green-background);
            position: fixed; left: 0; right: 0; bottom: 0;
            max-height: 90vh; border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15); z-index: 300;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .edit-mode-active .popup-sheet { z-index: 1000; }
        .popup-sheet.active { transform: translateY(0); }
        .popup-sheet.dragging { transition: none; }
        .popup-handle {
            width: 40px; height: 5px; background-color: var(--border-color);
            border-radius: 2.5px; margin: 10px auto; flex-shrink: 0;
        }
        
        /* TRANSACTION DETAIL POPUP */
        .transaction-detail-wrapper { flex-grow: 1; padding: 0 20px 30px 20px; overflow-y: auto; }
        .detail-header { text-align: center; padding-bottom: 20px; }
        .detail-category-icon {
            width: 60px; height: 60px; font-size: 28px; margin: 0 auto 15px auto;
            color: var(--white); background-color: var(--bper-green-medium);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        .detail-amount { font-size: 36px; font-weight: 700; }
        .detail-name { font-size: 18px; font-weight: 500; margin-top: 5px; }
        .detail-info-block {
            background-color: var(--white); border-radius: 16px;
            padding: 15px; margin-top: 20px;
        }
        .detail-info-row {
            display: flex; justify-content: space-between; font-size: 15px;
            padding: 12px 0; border-bottom: 1px solid var(--border-color);
        }
        .detail-info-row:last-child { border-bottom: none; }
        .detail-info-row span:first-child { color: var(--text-light); }
        .detail-info-row span:last-child { font-weight: 600; color: var(--text-dark); }
        
        /* SORT OPTIONS POPUP */
        #sort-options-popup .sort-options-wrapper { padding: 10px 20px calc(20px + var(--safe-area-bottom)); }
        #sort-options-popup h3 {
            font-size: 18px; font-weight: 700;
            text-align: center; margin: 10px 0 20px 0;
        }
        .sort-option {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background-color: var(--white);
            border-radius: 12px; margin-bottom: 10px;
            cursor: pointer; font-weight: 600;
        }
        .sort-option i { font-size: 18px; color: var(--bper-green-dark); visibility: hidden; }
        .sort-option.selected i { visibility: visible; }
        
        /* --- TOAST NOTIFICATION --- */
        .toast-notification {
            position: fixed; bottom: calc(95px + var(--safe-area-bottom));
            left: 50%; transform: translate(-50%, 20px);
            background-color: rgba(0,0,0,0.8); color: white;
            padding: 12px 25px; border-radius: 25px;
            z-index: 9999; opacity: 0; visibility: hidden;
            transition: all 0.3s ease;
        }
        .toast-notification.show { opacity: 1; visibility: visible; transform: translate(-50%, 0); }
    </style>
</head>
<body>

    <div id="edit-mode-banner">
        üïµÔ∏è‚Äç‚ôÇÔ∏è Modalit√† Modifica Attiva
        <button id="exit-edit-mode">Esci</button>
    </div>

    <header class="app-header">
        <div class="header-top">
            <div class="profile-initials">MS</div>
            <div class="header-icons">
                <i class="fa-solid fa-bell"></i>
                <i class="fa-solid fa-circle-question"></i>
            </div>
        </div>
        <nav class="nav-tabs">
            <div class="nav-tab active" data-target="conti-content">Conti</div>
            <div class="nav-tab" data-target="carte-content">Carte</div>
            <div class="nav-tab" data-target="finanziamenti-content">Finanziamenti</div>
            <div class="nav-tab" data-target="investimenti-content">Investimenti</div>
            <div class="nav-tab" data-target="mutui-content">Mutui</div>
            <div class="nav-tab" data-target="assicurazioni-content">Assicurazioni</div>
        </nav>
    </header>

    <main id="main-content">
        <div id="conti-content" class="content-section active-content">
            <h3 class="account-title-outside">
                <span data-editable="true" data-field="account-title">Conto 3657761</span>
                <i id="toggle-all-visibility" class="fa-solid fa-eye-slash toggle-icon"></i>
            </h3>
            <div class="account-summary">
                <div class="account-balance">
                    <span id="current-balance" data-editable="true" data-field="balance" data-balance="-11.07">-11,07&nbsp;‚Ç¨</span>
                    <i class="fa-solid fa-chevron-right arrow-icon"></i>
                </div>
                <p class="balance-info">Saldo disponibile al <span id="balance-date"></span><br><strong data-editable="true" data-field="account-holder">Sy Mouhamadou</strong></p>
                <div class="iban-details">
                    <span id="iban-text" data-editable="true" data-field="iban">IT25C0538753350000003657761</span>
                    <i id="copy-iban-button" class="fa-solid fa-arrow-up-from-bracket copy-icon"></i>
                </div>
            </div>
            
            <div class="quick-actions">
                <div class="action-item">
                    <i class="fa-solid fa-money-bill-transfer"></i>
                    <span>Bonifico<br>ordinario</span>
                </div>
                <div class="action-item">
                    <i class="fa-solid fa-mobile-screen"></i>
                    <span>Ricarica<br>Telefonica</span>
                </div>
                <div class="action-item">
                    <i class="fa-solid fa-receipt"></i>
                    <span>Cbill e<br>PagoPA</span>
                </div>
            </div>
            
            <div class="loader">
                <i class="fas fa-spinner fa-spin"></i>
            </div>

            <div class="transactions-card-wrapper" style="display: none;">
                <div class="card-header">
                    <h2 class="section-title">ULTIMI MOVIMENTI</h2>
                    <button id="add-predefined-tx-btn" class="add-tx-button" title="Aggiungi accredito stipendio">+ Stipendio</button>
                </div>
                <div class="transactions" id="main-transactions-list"></div>
                <div class="view-all-container">
                    <button id="view-all-transactions-btn" class="view-all-button">Visualizza tutto</button>
                </div>
            </div>
        </div>

        <section id="carte-content" class="content-section"><div class="placeholder-section"><i class="fa-solid fa-credit-card"></i><h3>Le tue Carte</h3><p>Gestisci limiti, pagamenti e sicurezza delle tue carte.</p></div></section>
        <section id="finanziamenti-content" class="content-section"><div class="placeholder-section"><i class="fa-solid fa-chart-line"></i><h3>Finanziamenti</h3><p>Controlla lo stato dei tuoi prestiti e finanziamenti.</p></div></section>
        <section id="investimenti-content" class="content-section"><div class="placeholder-section"><i class="fa-solid fa-seedling"></i><h3>Investimenti</h3><p>Monitora l'andamento del tuo portafoglio.</p></div></section>
        <section id="mutui-content" class="content-section"><div class="placeholder-section"><i class="fa-solid fa-house-chimney"></i><h3>Mutui</h3><p>Visualizza i dettagli e le rate del tuo mutuo.</p></div></section>
        <section id="assicurazioni-content" class="content-section"><div class="placeholder-section"><i class="fa-solid fa-shield-halved"></i><h3>Assicurazioni</h3><p>Gestisci le tue polizze e i tuoi sinistri.</p></div></section>
    </main>

    <section id="all-transactions-content">
        <div class="all-transactions-header">
            <i class="fa-solid fa-arrow-left back-arrow" id="back-to-conti"></i>
            <div class="title-and-balance">
                <h2 class="title">Movimenti Conto</h2>
                <span class="subtitle">Conto 3657761</span>
            </div>
        </div>
        <div class="search-filter-section">
            <div class="search-and-sort-container">
                <div class="search-bar-container">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" id="transaction-search-input" placeholder="Cerca per nome o importo">
                    <button class="clear-search-btn">&times;</button>
                </div>
                <button id="sort-transactions-btn" title="Ordina movimenti">
                    <i class="fa-solid fa-arrow-up-wide-short"></i>
                </button>
            </div>
            <div class="all-transactions-tabs">
                <div class="tab active" data-filter="all">Tutti</div>
                <div class="tab" data-filter="incomes">Entrate</div>
                <div class="tab" data-filter="expenses">Uscite</div>
            </div>
        </div>
        <div class="all-transactions-list-container">
            <div id="all-transactions-list" class="transactions"></div>
            <div class="no-results-message">
                <i class="fa-solid fa-box-open"></i>
                <p>Nessun movimento trovato</p>
            </div>
        </div>
    </section>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active"><i class="fa-solid fa-house"></i><span>Home</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-arrows-rotate"></i><span>Paga</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-qrcode"></i><span>QR</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-wallet"></i><span>Prodotti</span></a>
        <a href="#" class="nav-item"><i class="fa-solid fa-bars"></i><span>Menu</span></a>
    </nav>

    <div id="modal-backdrop"></div>

    <div id="transaction-detail-popup" class="popup-sheet">
        <div class="popup-handle"></div>
        <div class="transaction-detail-wrapper"></div>
    </div>
    
    <div id="sort-options-popup" class="popup-sheet">
        <div class="popup-handle"></div>
        <div class="sort-options-wrapper">
            <h3>Ordina movimenti per</h3>
            <div class="sort-option" data-sort="date_desc">
                <span>Data (pi√π recenti)</span>
                <i class="fa-solid fa-check"></i>
            </div>
            <div class="sort-option" data-sort="date_asc">
                <span>Data (meno recenti)</span>
                <i class="fa-solid fa-check"></i>
            </div>
            <div class="sort-option" data-sort="amount_desc">
                <span>Importo (dal pi√π alto)</span>
                <i class="fa-solid fa-check"></i>
            </div>
            <div class="sort-option" data-sort="amount_asc">
                <span>Importo (dal pi√π basso)</span>
                <i class="fa-solid fa-check"></i>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="toast-notification">Testo del toast</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- DATA ---
    const categoryIcons = {
        'payment': 'fa-solid fa-credit-card', 'transfer_in': 'fa-solid fa-arrow-down',
        'transfer_out': 'fa-solid fa-arrow-up', 'salary': 'fa-solid fa-briefcase',
        'groceries': 'fa-solid fa-cart-shopping', 'fuel': 'fa-solid fa-gas-pump',
        'cash': 'fa-solid fa-money-bill-wave', 'bills': 'fa-solid fa-file-invoice-dollar',
        'health': 'fa-solid fa-prescription-bottle-medical', 'loan': 'fa-solid fa-money-check-dollar',
        'phone': 'fa-solid fa-mobile-screen-button', 'car_wash': 'fa-solid fa-car-wash',
        'restaurant': 'fa-solid fa-utensils', 'default': 'fa-solid fa-receipt'
    };

    let transactionsData = [
        { id: 'tx_agosto_3', accountingDate: new Date('2025-08-11'), currencyDate: new Date('2025-08-11'), name: 'PAGAMENTO DELEGA F24', type: 'TASSE E IMPOSTE', amount: -172.53, status: null, details: 'Pagamento delega F24 online', category: 'bills'},
        { id: 'tx_agosto_1', accountingDate: new Date('2025-08-04'), currencyDate: new Date('2025-08-04'), name: 'PREMI ASSICURATIVI POLIZZ...', type: 'ADDEBITO', amount: -12.00, status: null, details: 'Addebito premi assicurativi', category: 'bills'},
        { id: 'tx_agosto_2', accountingDate: new Date('2025-08-04'), currencyDate: new Date('2025-08-04'), name: 'RICHIESTE LISTA MOV. DA ATM...', type: 'SPESE', amount: -0.66, status: null, details: 'Costo per richiesta lista movimenti da ATM', category: 'payment'},
        { id: 'tx_luglio_1', accountingDate: new Date('2025-07-25'), currencyDate: new Date('2025-07-25'), name: 'RATA PRESTITO BSS BIBANC...', type: 'RATA FINANZIAMENTO', amount: -145.60, status: null, details: 'Rata mensile prestito', category: 'loan'},
        { id: 'tx_luglio_2', accountingDate: new Date('2025-07-18'), currencyDate: new Date('2025-07-18'), name: 'PRELEVAMENTO DA CSA', type: 'PRELIEVO', amount: -150.00, status: null, details: 'Prelievo contanti', category: 'cash'},
        { id: 'tx_luglio_3', accountingDate: new Date('2025-07-14'), currencyDate: new Date('2025-07-14'), name: 'Prelievo atm c/o:CLUSONE O...', type: 'PRELIEVO', amount: -700.00, status: null, details: 'Prelievo contanti da ATM', category: 'cash'},
        { id: 'tx_luglio_7', accountingDate: new Date('2025-07-10'), currencyDate: new Date('2025-07-10'), name: 'Emolumenti o/c: Terya...', type: 'ACCREDITO', amount: 2483.00, status: null, details: 'Accredito emolumenti', category: 'salary'},
    ];

    // --- STATE VARIABLES ---
    let balancesVisible = true;
    let editMode = false;
    let profileClickCount = 0;
    let profileClickTimer = null;
    let currentFilter = 'all';
    let currentSort = 'date_desc';

    // --- DOM ELEMENTS ---
    const body = document.body;
    const mainContent = document.getElementById('main-content');
    const header = document.querySelector('.app-header');
    const mainTransactionsList = document.getElementById('main-transactions-list');
    const allTransactionsList = document.getElementById('all-transactions-list');
    const searchInput = document.getElementById('transaction-search-input');
    const clearSearchBtn = document.querySelector('.clear-search-btn');
    const profileInitials = document.querySelector('.profile-initials');
    const editModeBanner = document.getElementById('edit-mode-banner');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const txDetailPopup = document.getElementById('transaction-detail-popup');
    const sortOptionsPopup = document.getElementById('sort-options-popup');

    // --- INITIALIZATION ---
    function init() {
        setTimeout(() => {
            document.querySelector('.loader').style.display = 'none';
            document.querySelector('.transactions-card-wrapper').style.display = 'block';
            rerenderAllLists();
        }, 800);
        setupEventListeners();
        updateBalanceDate();
        updateSortOptionsUI();
    }
    
    // --- EVENT LISTENERS SETUP ---
    function setupEventListeners() {
        mainContent.addEventListener('scroll', () => { header.classList.toggle('scrolled', mainContent.scrollTop > 10); });
        
        document.querySelector('.nav-tabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('nav-tab')) {
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(content => content.classList.remove('active-content'));
                e.target.classList.add('active');
                document.getElementById(e.target.dataset.target).classList.add('active-content');
            }
        });
        
        document.getElementById('toggle-all-visibility').addEventListener('click', toggleBalanceVisibility);
        document.getElementById('copy-iban-button').addEventListener('click', copyIban);
        document.getElementById('view-all-transactions-btn').addEventListener('click', showAllTransactionsScreen);
        document.getElementById('back-to-conti').addEventListener('click', hideAllTransactionsScreen);

        document.getElementById('add-predefined-tx-btn').addEventListener('click', addPredefinedTransaction);

        searchInput.addEventListener('input', handleSearchFilterAndSort);
        clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; handleSearchFilterAndSort(); });
        document.querySelector('.all-transactions-tabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('tab')) {
                document.querySelectorAll('.all-transactions-tabs .tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                handleSearchFilterAndSort();
            }
        });

        document.getElementById('sort-transactions-btn').addEventListener('click', showSortOptions);
        document.querySelector('#sort-options-popup .sort-options-wrapper').addEventListener('click', (e) => {
            const sortOption = e.target.closest('.sort-option');
            if(sortOption) {
                currentSort = sortOption.dataset.sort;
                updateSortOptionsUI();
                handleSearchFilterAndSort();
                hideSortOptions();
            }
        });

        body.addEventListener('click', (e) => {
            if (editMode) return;
            const transactionItem = e.target.closest('.transaction-item');
            if (transactionItem) {
                const transaction = transactionsData.find(t => t.id === transactionItem.dataset.id);
                if (transaction) showTransactionDetail(transaction);
            }
        });
        
        modalBackdrop.addEventListener('click', () => {
             hideTransactionDetail();
             hideSortOptions();
        });

        profileInitials.addEventListener('click', handleProfileClick);
        document.getElementById('exit-edit-mode').addEventListener('click', () => toggleEditMode(false));
        
        setupSwipeToDismiss(txDetailPopup, hideTransactionDetail);
    }
    
    // --- RENDER & DATA UPDATE FUNCTIONS ---
    function rerenderAllLists() {
        const mainPageTxs = [...transactionsData].sort((a,b) => b.accountingDate - a.accountingDate).slice(0, 5);
        renderTransactions(mainPageTxs, mainTransactionsList);
        handleSearchFilterAndSort();
    }
    
    function handleSearchFilterAndSort() {
        const searchTerm = searchInput.value.toLowerCase();
        clearSearchBtn.style.display = searchTerm ? 'block' : 'none';

        const filtered = transactionsData.filter(tx => 
            (tx.name.toLowerCase().includes(searchTerm) || tx.amount.toString().replace('.',',').includes(searchTerm)) &&
            (currentFilter === 'all' || (currentFilter === 'incomes' && tx.amount > 0) || (currentFilter === 'expenses' && tx.amount < 0))
        );
        
        const sorters = {
            'date_desc': (a, b) => b.accountingDate - a.accountingDate,
            'date_asc': (a, b) => a.accountingDate - b.accountingDate,
            'amount_desc': (a, b) => b.amount - a.amount,
            'amount_asc': (a, b) => a.amount - b.amount
        };
        filtered.sort(sorters[currentSort]);
        
        renderTransactions(filtered, allTransactionsList);
    }
    
    function renderTransactions(transactions, container) {
        container.innerHTML = '';
        if (transactions.length === 0) {
            if (container.id === 'all-transactions-list') {
                document.querySelector('.no-results-message').style.display = 'block';
            }
        } else {
            if (container.id === 'all-transactions-list') {
                document.querySelector('.no-results-message').style.display = 'none';
            }
            transactions.forEach(tx => container.appendChild(createTransactionElement(tx)));
        }

        if (editMode) {
            setEditableState(true, container);
        }
    }

    function createTransactionElement(tx) {
        const item = document.createElement('div');
        item.className = 'transaction-item';
        item.dataset.id = tx.id;
        
        const amountClass = tx.amount > 0 ? 'positive' : 'negative';
        const formattedAmount = tx.amount.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
        
        const date = new Date(tx.accountingDate);
        const day = String(date.getDate()).padStart(2, '0');
        const month = date.toLocaleDateString('it-IT', { month: 'short' }).replace('.', '');

        item.innerHTML = `
            <div class="transaction-date-block">
                <span class="date-day">${day}</span>
                <span class="date-month">${month}</span>
            </div>
            <div class="transaction-info">
                <div class="transaction-name" data-editable="true" data-field="name">${tx.name}</div>
                <div class="transaction-type" data-editable="true" data-field="type">${tx.type}</div>
            </div>
            <div class="transaction-amount ${amountClass}" data-editable="true" data-field="amount">
                ${balancesVisible ? formattedAmount : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
            </div>`;
        return item;
    }

    // --- FEATURE FUNCTIONS ---
    function addPredefinedTransaction() {
        const newTransaction = {
            id: 'tx_' + Date.now(),
            accountingDate: new Date(),
            currencyDate: new Date(),
            name: 'Emolumenti o/c: Terya...',
            type: 'ACCREDITO',
            amount: 2483.00,
            status: null,
            details: 'Accredito stipendio aggiunto manualmente',
            category: 'salary'
        };

        transactionsData.unshift(newTransaction);

        const balanceEl = document.getElementById('current-balance');
        let currentBalance = parseFloat(balanceEl.dataset.balance);
        currentBalance += newTransaction.amount;
        balanceEl.dataset.balance = currentBalance.toFixed(2);
        
        if (balancesVisible) {
            balanceEl.innerHTML = currentBalance.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
        }

        rerenderAllLists();
        showToast('Stipendio accreditato!');
    }

    function handleProfileClick() {
        profileClickCount++;
        if (profileClickCount === 1) {
            profileClickTimer = setTimeout(() => { profileClickCount = 0; }, 400);
        }
        if (profileClickCount === 3) {
            clearTimeout(profileClickTimer);
            profileClickCount = 0;
            toggleEditMode();
        }
    }

    function toggleEditMode(forceState) {
        editMode = (forceState !== undefined) ? forceState : !editMode;
        body.classList.toggle('edit-mode-active', editMode);
        editModeBanner.style.display = editMode ? 'block' : 'none';
        setEditableState(editMode);
    }
    
    function setEditableState(isEditable, container = document) {
        const searchScope = isEditable ? container : document;
        searchScope.querySelectorAll('[data-editable="true"]').forEach(el => {
            el.contentEditable = isEditable;
            el.spellcheck = false;
            el.removeEventListener('blur', saveOnBlur); 
            if (isEditable) { 
                el.addEventListener('blur', saveOnBlur); 
            }
        });
    }

    function saveOnBlur(e) {
        const element = e.target;
        const field = element.dataset.field;
        const transactionItem = element.closest('.transaction-item');
        let newValue = element.innerText;

        if (transactionItem) {
            const txId = transactionItem.dataset.id;
            const transaction = transactionsData.find(t => t.id === txId);
            if (!transaction) return;
            if (field === 'amount') {
                newValue = parseFloat(newValue.replace(/[^0-9,-]+/g, "").replace(',', '.')) || 0;
            }
            transaction[field] = newValue;
        } else {
            const balanceEl = document.getElementById('current-balance');
            if (field === 'balance') {
                const numericValue = parseFloat(newValue.replace(/[^0-9,-]+/g, "").replace(',', '.')) || 0;
                balanceEl.dataset.balance = numericValue;
            }
        }
    }
    
    function toggleBalanceVisibility() {
        balancesVisible = !balancesVisible;
        const icon = document.getElementById('toggle-all-visibility');
        const balanceEl = document.getElementById('current-balance');
        icon.className = `toggle-icon fa-solid ${balancesVisible ? 'fa-eye-slash' : 'fa-eye'}`;
        
        if (balancesVisible) {
            const val = parseFloat(balanceEl.dataset.balance);
            balanceEl.innerHTML = val.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
        } else {
            balanceEl.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        }
        rerenderAllLists();
    }

    function copyIban() {
        const ibanText = document.getElementById('iban-text').textContent.replace(/\s/g, '');
        navigator.clipboard.writeText(ibanText).then(() => showToast('IBAN copiato!'));
    }

    function showToast(message) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // --- POPUP MANAGEMENT ---
    function showTransactionDetail(tx) {
        const wrapper = txDetailPopup.querySelector('.transaction-detail-wrapper');
        const formattedAmount = tx.amount.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
        wrapper.innerHTML = `
            <div class="detail-header">
                <div class="detail-category-icon"><i class="${categoryIcons[tx.category] || categoryIcons['default']}"></i></div>
                <div class="detail-amount ${tx.amount > 0 ? 'positive' : 'negative'}">${formattedAmount}</div>
                <div class="detail-name">${tx.name}</div>
            </div>
            <div class="detail-info-block">
                <div class="detail-info-row"><span>Causale</span><span>${tx.details}</span></div>
                <div class="detail-info-row"><span>Data contabile</span><span>${new Date(tx.accountingDate).toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' })}</span></div>
                <div class="detail-info-row"><span>Data valuta</span><span>${new Date(tx.currencyDate).toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' })}</span></div>
                <div class="detail-info-row"><span>Tipo movimento</span><span>${tx.type}</span></div>
            </div>
        `;
        showPopup(txDetailPopup);
    }
    function hideTransactionDetail() { hidePopup(txDetailPopup); }

    function showSortOptions() { showPopup(sortOptionsPopup); }
    function hideSortOptions() { hidePopup(sortOptionsPopup); }

    function showPopup(popupElement) {
        body.classList.add('modal-open');
        modalBackdrop.classList.add('active');
        popupElement.classList.add('active');
    }

    function hidePopup(popupElement) {
        body.classList.remove('modal-open');
        modalBackdrop.classList.remove('active');
        popupElement.classList.remove('active');
    }
    
    function updateSortOptionsUI() {
        document.querySelectorAll('#sort-options-popup .sort-option').forEach(opt => {
            opt.classList.toggle('selected', opt.dataset.sort === currentSort);
        });
    }

    // --- SCREEN MANAGEMENT & UTILITIES ---
    function showAllTransactionsScreen() { document.getElementById('all-transactions-content').classList.add('active'); }
    function hideAllTransactionsScreen() { document.getElementById('all-transactions-content').classList.remove('active'); }
    
    function updateBalanceDate() { 
        const now = new Date('2025-08-11');
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        document.getElementById('balance-date').textContent = `${day}/${month}/${year}`;
    }

    // --- SWIPE-TO-DISMISS GESTURE ---
    function setupSwipeToDismiss(popupElement, closeCallback) {
        let touchStartY = 0;
        let currentY = 0;
        let isDragging = false;
        const contentWrapper = popupElement.querySelector('.transaction-detail-wrapper, .sort-options-wrapper');

        popupElement.addEventListener('touchstart', (e) => {
            if (contentWrapper && contentWrapper.scrollTop === 0) {
                touchStartY = e.touches[0].clientY;
                isDragging = true;
                popupElement.classList.add('dragging');
            }
        }, { passive: true });

        popupElement.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            currentY = e.touches[0].clientY;
            const deltaY = currentY - touchStartY;
            if (deltaY > 0) {
                e.preventDefault();
                popupElement.style.transform = `translateY(${deltaY}px)`;
            }
        }, { passive: false });

        popupElement.addEventListener('touchend', () => {
            if (!isDragging) return;
            isDragging = false;
            popupElement.classList.remove('dragging');
            
            const deltaY = currentY - touchStartY;
            const popupHeight = popupElement.offsetHeight;

            if (deltaY > popupHeight / 4) {
                closeCallback();
            }
            popupElement.style.transform = '';
            touchStartY = 0;
            currentY = 0;
        });
    }

    // --- START THE APP ---
    init();
});
</script>

</body>
</html>
